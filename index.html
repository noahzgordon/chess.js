<!DOCTYPE html>

<html>
  <head>
		<link rel="stylesheet" href="style.css" type="text/css">
    <!-- jQuery library -->
    <script src="vendor/jquery-1.11.1.min.js" 
      type="text/javascript" charset="utf-8"></script>
    <!-- underscore.js library -->
    <script src="vendor/underscore-min.js" 
      type="text/javascript" charset="utf-8"></script>
    
    <script src="lib/utils.js" type="text/javascript"></script>
    <script src="lib/pieces/piece.js" type="text/javascript"></script>
    <script src="lib/pieces/pawn.js" type="text/javascript"></script>
    <script src="lib/pieces/rook.js" type="text/javascript"></script>
    <script src="lib/pieces/knight.js" type="text/javascript"></script>
    <script src="lib/pieces/bishop.js" type="text/javascript"></script>
    <script src="lib/pieces/queen.js" type="text/javascript"></script>
    <script src="lib/pieces/king.js" type="text/javascript"></script>
    <script src="lib/board.js" type="text/javascript"></script>
  </head>

  <body>
    <h1>CHESS.js</h1>
    
    <p class="turn">White's turn</p>
    
    <section class="board-wrapper group"></section>
    
    <section class="captured-wrapper group">
      <article class="white-captured"></article>
      <article class="black-captured"></article>
    </section>
  </body>
  
  <script>
    $(document).ready(function() {
      var board = new Chess.Board;
      board.resetAllMovesets();
      generateBoard(board);
      
      $(".tile").hover(function() {
        var piece = board.pieceAt(getCoords($(this)));
        if (piece && board.turn === piece.color) {
          $(this).addClass("hovered")
        }
      }, function() {
        var piece = board.pieceAt(getCoords($(this)));
        if (piece && board.turn === piece.color) {
          $(this).removeClass("hovered")
        }
      })
      
      $(".board").click(".tile", function(event) {
        $firstTile = $(event.target)
        
        if ($firstTile.hasClass("hovered")) {
          var piece = board.pieceAt(getCoords($firstTile));
          $firstTile.addClass("selected")
          
          piece.validMoves.forEach(function(pos) {
            $(".board")
              .find("[data-id='" + pos[0] + "-" + pos[1] + "']")
              .addClass("potential");
          })
          
          $(".board").on("click.sec", ".tile", function(event) {
            $secondTile = $(event.target);
            
            if ($secondTile.hasClass("potential")) {
              var start_pos = getCoords($firstTile);
              var end_pos = getCoords($secondTile);
              
              if (board.move(start_pos, end_pos)) {
                var pieceClass = $firstTile.attr("class");
                $firstTile.removeClass().addClass("tile");
                $secondTile.removeClass().addClass(pieceClass);
                
                $(".turn").html(capitalize(board.turn) + "'s turn")
                updateCaptures(board);
              }
            }
            
            $(".tile").removeClass("selected potential");
            $(".board").off("click.sec");
            
          });
        } 
      });
      
    });
    
    function generateBoard(board) {
      var $board = $("<ul>").addClass("board group");
      $(".board-wrapper").append($board);
      
      for (var i = 0; i < 8; i++) {
        var $row = $("<ul>")
          .addClass("row group")
          .attr("data-id", 7 - i)
        $board.append($row);
        
        for (var j = 0; j < 8; j++) {
          var coords = [j, 7 - i]
          var $tile = $("<li>")
            .addClass("tile")
            .attr("data-id", coords[0] + "-" + coords[1]);
          
          var piece = board.pieceAt(coords);
          if (piece) {
            $tile.addClass(piece.pieceName).addClass(piece.color);
          }
          $row.append($tile);
        }
      }
    }
    
    function updateCaptures(board) {
      $whites = $(".white-captured").empty();
      $blacks = $(".black-captured").empty();
      
      board.capturedWhites.forEach(function(piece) {
        $div = $("<div>")
          .addClass("capture")
          .addClass(piece.pieceName)
          .addClass(piece.color);
          
        $whites.append($div);
      })
      
      board.capturedBlacks.forEach(function(piece) {
        $div = $("<div>")
          .addClass("capture")
          .addClass(piece.pieceName)
          .addClass(piece.color);
          
        $blacks.append($div);
      })
    }
    
    function getCoords(tile) {
      return tile.data("id").split("-").map(Math.floor);
    }
    
    function capitalize(str) {
      return str.charAt(0).toUpperCase() + str.slice(1);
    }
  </script>
</html>